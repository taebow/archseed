#!/usr/bin/env bash
set -euo pipefail

usage() {
    cat <<EOF
Usage:
    $0 --efi <EFI PARTITION> --root <ROOT PARTITION> [options]

Options:
    Additional boot partition (if existing efi too small)
    --xbootldr <XBOOTLDR PARTITION>
}
EOF
}

parse_args() {
    while [[ $# -gt 0 ]]; do
        case $1 in
            --efi)
                EFI_PARTITION="$2"
                shift 2
                ;;
            --xbootldr)
                XBOOTLDR_PARTITION="$2"
                shift 2
                ;;
            --root)
                ROOT_PARTITION="$2"
                shift 2
                ;;
            -h)
                usage
                exit 0
                ;;
            *)
                echo "Unknown option: $1"
                usage
                exit 1
                ;;
        esac
    done
    [[ -v EFI_PARTITION && -v ROOT_PARTITION ]] || {
        echo "Missing required option" >&2
        usage
        exit 1
    }
}

confirm() {
    echo "Configuration Summary:"
    echo "===================================="
    echo "EFI partition:        $EFI_PARTITION"
    echo "ROOT partition:       $ROOT_PARTITION"
    echo "XBOOTLDR partition:   ${XBOOTLDR_PARTITION:-(not set)}"
    echo "===================================="
    read -p "Continue with these settings? (y/n): " -n 1 -r; echo
    [[ $REPLY =~ ^[Yy]$ ]] || {
        echo "Aborted" >&2
        exit 1
    }
}

get_password() {
    local -n var=$1
    local password password_confirm
    while true; do
        read -rs -p "$2 :" password; echo
        read -rs -p "Confirm password :" password_confirm; echo
        [ "${password}" == "${password_confirm}" ] && break
        echo "Passwords do not match! Try again." >&2
    done
    var="${password}"
}

to_be_splitted() {
HOSTNAME="archlinux"
TIMEZONE="Europe/Paris"
LOCALE="en_US.UTF-8"
KEYMAP="dvorak"
XKBLAYOUT="us"
XKBVARIANT="dvorak-alt-intl"

BASE_PACKAGES="base linux linux-firmware"
ESSENTIAL_PACKAGES="base-devel networkmanager vim sudo git btop iwd zsh tree ncdu neovim lynx nmap rsync traceroute zip yadm plymouth"
ADDITIONAL_PACKAGES="man-db man-pages texinfo btrfs-progs"
MICROCODE_PACKAGE=$(grep -q GenuineIntel /proc/cpuinfo && echo intel-ucode || echo amd-ucode)

USER="t"
get_password PASSWORD "Password"

EFI_MOUNTPOINT="boot"
if [[ -v XBOOTLDR_PARTITION ]]; then
    echo "==> Formatting XBOOTLDR partition..."
    mkfs.fat -F32 "$XBOOTLDR_PARTITION"
    EFI_MOUNTPOINT="efi"
fi

echo "==> Setting up LUKS encryption on root partition..."
echo -n "$PASSWORD" | cryptsetup luksFormat "$ROOT_PARTITION" -q

echo "==> Opening encrypted partition..."
echo -n "$PASSWORD" | cryptsetup open "$ROOT_PARTITION" cryptroot

echo "==> Formatting root partition..."
mkfs.btrfs  /dev/mapper/cryptroot

echo "==> Mounting filesystems..."
mount /dev/mapper/cryptroot /mnt

mkdir -p /mnt/$EFI_MOUNTPOINT
mount "$EFI_PARTITION" "/mnt/$EFI_MOUNTPOINT"

if [[ -v XBOOTLDR_PARTITION ]]; then
    mkdir -p /mnt/boot
    mount "$XBOOTLDR_PARTITION" /mnt/boot
fi

# Install base system
echo "==> Installing base system..."
pacstrap /mnt $BASE_PACKAGES $ESSENTIAL_PACKAGES $ADDITIONAL_PACKAGES $MICROCODE_PACKAGE

echo "==> Generating fstab..."
genfstab -U /mnt >> /mnt/etc/fstab

ROOT_UUID=$(blkid -s UUID -o value "$ROOT_PARTITION")

echo "==> Configuring system..."
arch-chroot -S /mnt /bin/bash <<EOF
set -euo pipefail

# Set timezone
ln -sf /usr/share/zoneinfo/$TIMEZONE /etc/localtime
hwclock --systohc

# Set locale
echo "$LOCALE UTF-8" >> /etc/locale.gen
locale-gen
echo "LANG=$LOCALE" > /etc/locale.conf

# Set keymap
cat > /etc/vconsole.conf <<VCONSOLE
KEYMAP=$KEYMAP
XKBLAYOUT=$XKBLAYOUT
XKBVARIANT=$XKBVARIANT
VCONSOLE

# Set hostname
echo "$HOSTNAME" > /etc/hostname

# Configure mkinitcpio for encryption
sed -i 's/^HOOKS=.*/HOOKS=(base systemd plymouth autodetect modconf kms keyboard sd-vconsole block sd-encrypt filesystems fsck)/' /etc/mkinitcpio.conf

# Regenerate initramfs
mkinitcpio -P

# Install systemd-boot
if [[ -v XBOOTLDR_PARTITION ]]; then
    bootctl install --esp-path=/efi --boot-path=/boot
else
    bootctl install
fi

# Configure systemd-boot loader
cat > /$EFI_MOUNTPOINT/loader/loader.conf <<LOADER
default arch.conf
timeout 1
console-mode max
editor no
LOADER

# Create boot entry
cat > /boot/loader/entries/arch.conf <<BOOTENTRY
title   Arch Linux
linux   /vmlinuz-linux
initrd  /$MICROCODE_PACKAGE.img
initrd  /initramfs-linux.img
options rd.luks.name=$ROOT_UUID=cryptroot root=/dev/mapper/cryptroot rw quiet splash
BOOTENTRY

# Create fallback boot entry
cat > /boot/loader/entries/arch-fallback.conf <<BOOTENTRY
title   Arch Linux (fallback initramfs)
linux   /vmlinuz-linux
initrd  /$MICROCODE_PACKAGE.img
initrd  /initramfs-linux-fallback.img
options rd.luks.name=$ROOT_UUID=cryptroot root=/dev/mapper/cryptroot rw
BOOTENTRY

# Create user if specified
useradd -m -G wheel -s /bin/bash $USER

# Set passwords
chpasswd <<SETROOTPASSWORD
root:${PASSWORD}
SETROOTPASSWORD

chpasswd <<SETUSERPASSWORD
$USER:${PASSWORD}
SETUSERPASSWORD

# Enable sudo for wheel group
sed -i 's/^# %wheel ALL=(ALL:ALL) ALL/%wheel ALL=(ALL:ALL) ALL/' /etc/sudoers

# Enable NetworkManager
systemctl enable NetworkManager

sync
echo ""
echo "==> System configuration complete!"

EOF

umount /mnt/$EFI_MOUNTPOINT
[[ -v XBOOTLDR_PARTITION ]] && umount /mnt/boot
umount /mnt
cryptsetup close cryptroot

echo "Don't forget to change the default passwords!"
}

main() {
    parse_args "$@"
    confirm
    to_be_splitted
}

main "$@"
